<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNT Attendance Manager</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #e65100; --success: #2e7d32; --danger: #d32f2f; --bg: #fff8f1; --default-btn: #f0f0f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { max-width: 500px; margin: 10px auto; background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: var(--primary); color: white; padding: 25px; text-align: center; border-bottom: 5px solid #ffb74d; }
        
        /* Date Picker */
        .date-picker { padding: 20px; display: flex; justify-content: center; gap: 10px; background: #fff3e0; border-bottom: 1px solid #ffe0b2; }
        select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; }

        /* Student Row */
        .st-list { padding: 10px 20px; max-height: 450px; overflow-y: auto; }
        .st-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .st-name { font-size: 16px; font-weight: 600; color: #333; }

        /* Attendance Buttons Logic */
        .btn-group { display: flex; gap: 10px; }
        .btn { 
            border: none; padding: 10px 22px; border-radius: 10px; 
            cursor: pointer; font-weight: 800; font-size: 15px;
            background: var(--default-btn); color: #666; 
            transition: all 0.2s ease; outline: none;
        }
        
        /* Click Animation */
        .btn:active { transform: scale(0.85); }

        /* P - Green Style when Active */
        .p-btn.active { 
            background: var(--success) !important; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
        }

        /* A - Red Style when Active */
        .a-btn.active { 
            background: var(--danger) !important; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
        }

        /* Holiday UI */
        .holiday-banner { display: none; padding: 30px; text-align: center; background: #fff3e0; border: 2px dashed var(--primary); margin: 15px; border-radius: 15px; }
        
        .footer { padding: 20px; text-align: center; }
        .save-btn { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 15px; width: 100%; font-weight: bold; cursor: pointer; font-size: 17px; }
    </style>
</head>
<body>

<div class="card">
    <header><h2>SNT COMPUTER INSTITUTE</h2><p>Attendance Management</p></header>
    
    <div class="date-picker">
        <select id="day" onchange="checkCloudData()"></select>
        <select id="month" onchange="checkCloudData()">
            <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
            <option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option>
            <option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option>
            <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
        <select id="year" onchange="checkCloudData()"></select>
    </div>

    <div id="holiday-banner" class="holiday-banner">
        <h2 id="holiday-text">आज छुट्टी है!</h2>
        <button onclick="manualOpen()" style="border:none; background:none; color:var(--primary); text-decoration:underline; cursor:pointer;">अटेंडेंस लगायें</button>
    </div>

    <div id="attendance-box">
        <div class="st-list" id="st-list"></div>
    </div>

    <div class="footer">
        <button class="save-btn" onclick="saveToFirebase()">Cloud पर सुरक्षित करें ✅</button>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA",
        authDomain: "snt-computer-institute.firebaseapp.com",
        projectId: "snt-computer-institute",
        databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/",
        storageBucket: "snt-computer-institute.firebasestorage.app",
        messagingSenderId: "117580784781",
        appId: "1:117580784781:web:73ba19d2d008beb3a5eec4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentAttendance = {};
    let isHoliday = false;

    // Dates Setup
    const d = new Date();
    const dayS = document.getElementById('day'), monS = document.getElementById('month'), yerS = document.getElementById('year');
    
    for(let i=2025; i<=2030; i++) yerS.innerHTML += `<option value="${i}">${i}</option>`;
    for(let i=1; i<=31; i++) dayS.innerHTML += `<option value="${i<10?'0'+i:i}">${i}</option>`;
    
    dayS.value = String(d.getDate()).padStart(2,'0');
    monS.value = String(d.getMonth()+1).padStart(2,'0');
    yerS.value = d.getFullYear();

    function checkCloudData() {
        const dateKey = `${dayS.value}-${monS.value}-${yerS.value}`;
        db.ref('attendance/' + dateKey).once('value', snap => {
            const val = snap.val();
            if(val && val.type === 'HOLIDAY') {
                showHoliday(val.name);
            } else {
                hideHoliday();
                loadStudents(val ? val.details : null);
            }
        });
    }

    function showHoliday(name) {
        isHoliday = true;
        document.getElementById('holiday-banner').style.display = 'block';
        document.getElementById('attendance-box').style.display = 'none';
        document.getElementById('holiday-text').innerText = name || "आज छुट्टी है!";
    }

    function hideHoliday() {
        isHoliday = false;
        document.getElementById('holiday-banner').style.display = 'none';
        document.getElementById('attendance-box').style.display = 'block';
    }

    function manualOpen() {
        hideHoliday();
        loadStudents();
    }

    function loadStudents(savedData = null) {
        db.ref('students').once('value', snap => {
            const list = document.getElementById('st-list');
            list.innerHTML = "";
            currentAttendance = savedData || {};

            snap.forEach(child => {
                const sid = child.key;
                const sname = child.val().name;
                const status = currentAttendance[sid] || "";

                list.innerHTML += `
                    <div class="st-row">
                        <span class="st-name">${sname}</span>
                        <div class="btn-group">
                            <button id="p-${sid}" class="btn p-btn ${status==='P'?'active':''}" onclick="markAttendance('${sid}','P')">P</button>
                            <button id="a-${sid}" class="btn a-btn ${status==='A'?'active':''}" onclick="markAttendance('${sid}','A')">A</button>
                        </div>
                    </div>`;
            });
        });
    }

    // MAIN LOGIC: Button Click Color Switch
    function markAttendance(studentId, status) {
        // 1. डेटा अपडेट करें
        currentAttendance[studentId] = status;

        // 2. उस छात्र के दोनों बटनों से 'active' क्लास हटाएँ (Default कर दें)
        document.getElementById(`p-${studentId}`).classList.remove('active');
        document.getElementById(`a-${studentId}`).classList.remove('active');

        // 3. जो स्टेटस चुना गया है, सिर्फ उसे 'active' करें (Green या Red होगा)
        if(status === 'P') {
            document.getElementById(`p-${studentId}`).classList.add('active');
        } else {
            document.getElementById(`a-${studentId}`).classList.add('active');
        }
    }

    function saveToFirebase() {
        const dateKey = `${dayS.value}-${monS.value}-${yerS.value}`;
        const data = {
            type: isHoliday ? 'HOLIDAY' : 'ATTENDANCE',
            details: currentAttendance,
            lastUpdated: new Date().toLocaleString()
        };

        db.ref('attendance/' + dateKey).set(data).then(() => {
            alert("डेटा सुरक्षित कर दिया गया! ✅");
        }).catch(e => alert("Error: " + e.message));
    }

    window.onload = checkCloudData;
</script>
</body>
</html>
