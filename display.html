<!DOCTYPE html>
<html lang="hi">
<head>
  <link rel="icon" type="image/jpeg" href="SNT.jpg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNT Institute - Admin Dashboard Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    :root { --primary: #e65100; --secondary: #1a73e8; --success: #2e7d32; --danger: #d32f2f; --bg: #fffbf5; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; user-select: none; }
    header { background: var(--primary); color: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(230, 81, 0, 0.2); }
    header h1 { font-size: 20px; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
    .search-container { margin: 15px 0; }
    #search-input { width: 100%; padding: 14px 20px; border: 2px solid #ddd; border-radius: 30px; outline: none; font-size: 16px; transition: 0.3s; box-sizing: border-box; }
    #search-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(230,81,0,0.1); }
    .outer-wrapper { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1100px; }
    th { background: #f8f9fa; color: #666; padding: 15px; font-size: 13px; text-align: center; border-bottom: 2px solid #eee; }
    td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 13px; text-align: center; vertical-align: middle; }
    .profile-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); padding: 2px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
    .btn { padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-green { background: var(--success); color: white; }
    .btn-blue { background: var(--secondary); color: white; }
    .btn-orange { background: var(--primary); color: white; }
    .btn-yellow { background: #fbbc05; color: black; }
    .btn-red { background: var(--danger); color: white; grid-column: span 2; }
    .form-box { display: none; background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); margin-top: 10px; }
    input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    .fee-badge { padding: 4px 8px; border-radius: 6px; display: inline-block; margin: 2px; font-size: 11px; font-weight: bold; background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
    .extra-badge { background: #e8f0fe; color: #1a73e8; border: 1px solid #d0e1fd; }
    #common-modal, #password-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
    .modal-content { background:white; padding:25px; border-radius:25px; text-align:center; width: 320px; position: relative; }
    .calc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .calc-btn { background: #f0f0f0; border: none; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .scratch-container { position: relative; width: 260px; height: 260px; background: #fff; margin: 20px auto; border-radius: 20px; overflow: hidden; border: 4px solid #eee; }
    #scratch-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; z-index: 2; }
    .reward-under { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1; background: #fff; }
    .att-count { background: #333; color: #fff; padding: 2px 8px; border-radius: 20px; font-size: 11px; cursor: pointer; }
  </style>
</head>
<body oncontextmenu="return false;">

  <header>
    <h1>SNT Computer Institute</h1>
    <button class="btn" style="padding:8px 12px; background:rgba(255,255,255,0.2);" onclick="location.reload()">üîÑ</button>
  </header>
  
  <div class="search-container">
    <input type="text" id="search-input" placeholder="‡§®‡§æ‡§Æ, ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Ø‡§æ Gmail ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="filterTable()">
  </div>
  
  <div class="outer-wrapper">
    <div class="table-scroll">
        <table id="data-table">
          <thead>
            <tr>
              <th>‡§ö‡•Å‡§®‡•á‡§Ç</th>
              <th>Student ID</th> 
              <th>‡§´‡•ã‡§ü‡•ã</th>
              <th>‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£</th>
              <th>‡§ï‡•ã‡§∞‡•ç‡§∏</th>
              <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ / Gmail</th> 
              <th>‡§π‡§æ‡§ú‡§ø‡§∞‡•Ä</th>
              <th>‡§´‡•Ä‡§∏ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</th>
              <th>‡§á‡§®‡§æ‡§Æ</th>
              <th>‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</th>
            </tr>
          </thead>
          <tbody id="table-body">
            </tbody>
        </table>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-green" onclick="showForm('payment-form')">üí∞ ‡§´‡•Ä‡§∏ ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
    <button class="btn btn-blue" onclick="showForm('extra-charge-form')">üìë ‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú</button>
    <button class="btn btn-orange" onclick="openPinGate('attendance')">üìù ‡§Ö‡§ü‡•á‡§Ç‡§°‡•á‡§Ç‡§∏ ‡§≠‡§∞‡•á‡§Ç</button>
    <button class="btn btn-yellow" onclick="openScracityModal()">üéÅ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•à‡§ö ‡§ï‡•Ç‡§™‡§®</button>
    <button class="btn btn-red" onclick="openPinGate('delete')">üóëÔ∏è ‡§ö‡§Ø‡§®‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <div id="payment-form" class="form-box">
    <h3>‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§´‡•Ä‡§∏ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</h3>
    <select id="p-month">
      <option>Admission Fee</option><option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option><option>July</option>
      <option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
    </select>
    <input type="number" id="p-amount" placeholder="‡§∞‡§æ‡§∂‡§ø ‚Çπ">
    <button class="btn btn-green" style="width:100%" onclick="genQRCode('fee')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="extra-charge-form" class="form-box">
    <h3>‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú</h3>
    <input type="text" id="e-reason" placeholder="‡§ï‡§æ‡§∞‡§£ (‡§ú‡•à‡§∏‡•á- Exam, Card)">
    <input type="number" id="e-amount" placeholder="‡§∞‡§æ‡§∂‡§ø ‚Çπ">
    <button class="btn btn-blue" style="width:100%" onclick="genQRCode('extra')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="password-modal">
    <div class="modal-content">
        <h3 id="pin-msg">üîí ‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</h3>
        <input type="password" id="pin-input" readonly placeholder="******" style="text-align:center; font-size:20px; border:2px solid #eee; width:80%;">
        <div class="calc-grid">
            <button class="calc-btn" onclick="addPin('1')">1</button><button class="calc-btn" onclick="addPin('2')">2</button><button class="calc-btn" onclick="addPin('3')">3</button>
            <button class="calc-btn" onclick="addPin('4')">4</button><button class="calc-btn" onclick="addPin('5')">5</button><button class="calc-btn" onclick="addPin('6')">6</button>
            <button class="calc-btn" onclick="addPin('7')">7</button><button class="calc-btn" onclick="addPin('8')">8</button><button class="calc-btn" onclick="addPin('9')">9</button>
            <button class="calc-btn" style="color:red" onclick="clearPin()">C</button><button class="calc-btn" onclick="addPin('0')">0</button>
            <button class="calc-btn" style="color:green" onclick="verifyPin()">OK</button>
        </div>
        <button onclick="closePinModal()" style="margin-top:15px; border:none; background:none; cursor:pointer; color:gray;">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
  </div>

  <div id="common-modal">
      <div class="modal-content" id="qr-ui" style="display:none;">
          <h3 id="qr-title">Sandeep Kumar</h3>
          <div id="qrcode-container" style="display: flex; justify-content: center; margin: 15px 0;"></div>
          <p id="qr-text"></p>
          <button class="btn btn-green" id="confirm-btn">‚úÖ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§´‡§≤</button>
          <button onclick="closeModal()" style="margin-top:10px; border:none; background:none; color:gray; cursor:pointer;">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
      <div class="modal-content" id="scratch-ui" style="display:none;">
          <h3>‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ï‡§æ ‡§á‡§®‡§æ‡§Æ</h3>
          <div class="scratch-container">
              <div class="reward-under"><h2 id="win-txt">‚Çπ0</h2><p>‡§®‡§ï‡§¶ ‡§™‡•Å‡§∞‡§∏‡•ç‡§ï‡§æ‡§∞</p></div>
              <canvas id="scratch-canvas" width="260" height="260"></canvas>
          </div>
          <button onclick="saveReward()" class="btn btn-orange" style="width:100%">‚úÖ ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
      </div>
  </div>

  <script>
    // --- Security ---
    document.addEventListener('keydown', (e) => {
        if (e.keyCode >= 112 && e.keyCode <= 123) e.preventDefault();
        if (e.ctrlKey && (e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67) || e.keyCode === 85)) e.preventDefault();
    });

    // --- Firebase Initialization ---
    const firebaseConfig = { 
        apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA", 
        authDomain: "snt-computer-institute.firebaseapp.com", 
        databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/", 
        projectId: "snt-computer-institute", 
        appId: "1:117580784781:web:73ba19d2d008beb3a5eec4" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let usersData = [];
    let currentId = null; 
    let enteredPin = "";
    let pinTarget = "";
    let lastWinAmount = 0;
    const MASTER_PIN = "912919";

    // --- Load Students ---
    function fetchStudents() {
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            usersData = [];
            if (data) {
                Object.keys(data).forEach((key) => {
                    let u = data[key]; 
                    u.id = key; 
                    usersData.push(u);
                    let pHist = (u.paymentHistory || []).map(p => `<span class="fee-badge">${p.month}: ‚Çπ${p.amount}</span>`).join('');
                    let eHist = (u.extraHistory || []).map(e => `<span class="fee-badge extra-badge">${e.reason}: ‚Çπ${e.amount}</span>`).join('');
                    
                    tbody.innerHTML += `<tr>
                      <td><input type="checkbox" class="st-check" data-id="${key}"></td>
                      <td style="font-weight:bold; color:var(--secondary);">${u.studentId || 'N/A'}</td> 
                      <td><img src="${u.profilePicture || 'SNT.jpg'}" class="profile-img"></td>
                      <td style="text-align:left;"><b>${u.name}</b><br><small style="color:${u.registrationStatus === 'Pending' ? 'red' : 'green'}">${u.registrationStatus || 'Paid'}</small></td>
                      <td><span class="fee-badge extra-badge">${u.courses ? u.courses.join(', ') : 'N/A'}</span></td>
                      <td style="font-size:11px;">${u.mobile || u.phone}<br>${u.email || ''}</td> 
                      <td><div class="att-count" onclick="location.href='calendar.html?id=${key}&name=${u.name}'">üìÖ History</div></td>
                      <td><div style="max-width:200px; margin:auto;">${pHist} ${eHist}</div></td>
                      <td style="color:var(--success); font-weight:bold;">‚Çπ${u.wonCash || 0}</td>
                      <td><button class="btn" onclick="window.location.href='receipt.html?id=${key}'">üñ®Ô∏è</button></td>
                    </tr>`;
                });
            }
        });
    }

    // --- PIN System ---
    function openPinGate(target) {
        if(target === 'delete' && document.querySelectorAll('.st-check:checked').length === 0) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        pinTarget = target; enteredPin = ""; 
        document.getElementById('pin-input').value = ""; 
        document.getElementById('password-modal').style.display = 'flex';
    }

    function addPin(num) { if(enteredPin.length < 6) { enteredPin += num; document.getElementById('pin-input').value = enteredPin.replace(/./g, '‚óè'); } }
    function clearPin() { enteredPin = ""; document.getElementById('pin-input').value = ""; }
    function closePinModal() { document.getElementById('password-modal').style.display = 'none'; }
    
    function verifyPin() {
        if(enteredPin === MASTER_PIN) {
            if(pinTarget === 'attendance') location.href = 'attendence.html';
            else if(pinTarget === 'delete') deleteRows();
            closePinModal();
        } else { alert("‡§ó‡§≤‡§§ ‡§™‡§ø‡§®!"); clearPin(); }
    }

    function deleteRows() {
        if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
        document.querySelectorAll('.st-check:checked').forEach(c => db.ref('students/' + c.dataset.id).remove());
        alert("‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!");
    }

    // --- Payments & QR ---
    function genQRCode(type) {
        const sel = document.querySelector('.st-check:checked');
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id;
        let amt = (type === 'fee') ? document.getElementById('p-amount').value : document.getElementById('e-amount').value;
        let label = (type === 'fee') ? document.getElementById('p-month').value : document.getElementById('e-reason').value;
        if(!amt) return alert("‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!");

        document.getElementById('common-modal').style.display='flex'; 
        document.getElementById('qr-ui').style.display='block'; 
        document.getElementById('scratch-ui').style.display='none';
        document.getElementById('qrcode-container').innerHTML = "";
        
        new QRCode(document.getElementById('qrcode-container'), { 
            text: `upi://pay?pa=9580807075@ybl&pn=Sandeep%20Kumar&am=${amt}&cu=INR`, 
            width:180, height:180 
        });
        
        document.getElementById('qr-title').innerText = usersData.find(u => u.id === currentId).name;
        document.getElementById('qr-text').innerText = `${label}: ‚Çπ${amt}`;
        document.getElementById('confirm-btn').onclick = () => confirmPayment(type, amt, label);
    }

    function confirmPayment(type, amt, label) {
        let student = usersData.find(u => u.id === currentId);
        if(type === 'fee') {
            if(!student.paymentHistory) student.paymentHistory = [];
            student.paymentHistory.push({month: label, amount: amt, date: new Date().toLocaleDateString()});
            if(label === "Admission Fee") student.registrationStatus = "Paid";
        } else {
            if(!student.extraHistory) student.extraHistory = [];
            student.extraHistory.push({reason: label, amount: amt, date: new Date().toLocaleDateString()});
        }
        db.ref('students/' + currentId).update(student).then(() => {
            closeModal();
            alert("Payment Recorded!");
        });
    }

    function filterTable() {
        let input = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('#table-body tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    }

    function showForm(id) {
        document.querySelectorAll('.form-box').forEach(f => f.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    function closeModal() { document.getElementById('common-modal').style.display='none'; }

    // --- Scratch Coupon ---
    const canvas = document.getElementById('scratch-canvas'); 
    const ctx = canvas.getContext('2d'); 
    let isDrawing = false;

    function openScracityModal() {
        const sel = document.querySelector('.st-check:checked'); 
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id; 
        lastWinAmount = Math.floor(Math.random() * 15) + 1;
        document.getElementById('win-txt').innerText = `‚Çπ${lastWinAmount}`;
        document.getElementById('common-modal').style.display='flex'; 
        document.getElementById('scratch-ui').style.display='block'; 
        document.getElementById('qr-ui').style.display='none';
        
        ctx.globalCompositeOperation = 'source-over'; 
        ctx.fillStyle = '#C0C0C0'; 
        ctx.fillRect(0, 0, 260, 260);
        ctx.fillStyle = "#888";
        ctx.font = "bold 20px Arial";
        ctx.fillText("SNT SCRATCH", 60, 135);
    }

    function scratch(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctx.globalCompositeOperation = 'destination-out'; 
        ctx.lineWidth = 40; 
        ctx.lineCap = 'round'; 
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y); ctx.stroke();
    }

    canvas.addEventListener('mousedown', () => isDrawing = true);
    canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
    window.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mousemove', scratch);
    canvas.addEventListener('touchmove', scratch);

    function saveReward() {
        let student = usersData.find(u => u.id === currentId);
        let totalWon = (parseInt(student.wonCash) || 0) + lastWinAmount;
        db.ref('students/' + currentId).update({ wonCash: totalWon }).then(() => {
            alert(`Winner! ‚Çπ${lastWinAmount} added.`);
            closeModal();
        });
    }

    window.onload = fetchStudents;
  </script>
</body>
</html>
