<!DOCTYPE html>
<html lang="hi">
<head>
      <link rel="icon" type="image/jpeg" href="SNT.jpg">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNT Institute - Admin Dashboard Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    :root { --primary: #e65100; --secondary: #1a73e8; --success: #2e7d32; --danger: #d32f2f; --bg: #fffbf5; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
    header { background: var(--primary); color: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(230, 81, 0, 0.2); }
    header h1 { font-size: 20px; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
    .search-container { margin: 15px 0; }
    #search-input { width: 100%; padding: 14px 20px; border: 2px solid #ddd; border-radius: 30px; outline: none; font-size: 16px; transition: 0.3s; box-sizing: border-box; }
    #search-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(230,81,0,0.1); }
    .outer-wrapper { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f8f9fa; color: #666; padding: 15px; font-size: 13px; text-align: center; border-bottom: 2px solid #eee; }
    td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 13px; text-align: center; vertical-align: middle; }
    .profile-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); padding: 2px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
    .btn { padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-green { background: var(--success); color: white; }
    .btn-blue { background: var(--secondary); color: white; }
    .btn-orange { background: var(--primary); color: white; }
    .btn-yellow { background: #fbbc05; color: black; }
    .btn-red { background: var(--danger); color: white; grid-column: span 2; }
    .form-box { display: none; background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); margin-top: 10px; }
    input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    .fee-badge { padding: 4px 8px; border-radius: 6px; display: inline-block; margin: 2px; font-size: 11px; font-weight: bold; background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
    .extra-badge { background: #e8f0fe; color: #1a73e8; border: 1px solid #d0e1fd; }
    #common-modal, #password-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
    .modal-content { background:white; padding:25px; border-radius:25px; text-align:center; width: 320px; position: relative; }
    .scratch-container { position: relative; width: 260px; height: 260px; background: #fff; margin: auto; border-radius: 20px; overflow: hidden; border: 4px solid #eee; }
    #scratch-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; z-index: 2; transition: opacity 0.5s; }
    .reward-under { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1; }
    .att-count { background: #333; color: #fff; padding: 2px 8px; border-radius: 20px; font-size: 11px; }

    /* Calculator Style */
    .calc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .calc-btn { background: #f0f0f0; border: none; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .calc-btn:active { background: #ddd; }
  </style>
</head>
<body>

  <header>
    <h1>SNT Computer Institute</h1>
    <div style="display:flex; gap:8px;">
       <button class="btn" title="Backup" style="padding:8px 12px; background:rgba(255,255,255,0.2);" onclick="exportFullData()">üì•</button>
    </div>
  </header>

  <div class="search-container">
    <input type="text" id="search-input" placeholder="‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="filterTable()">
  </div>

  <div class="outer-wrapper">
    <div class="table-scroll">
        <table id="data-table">
          <thead>
            <tr>
              <th>‡§ö‡•Å‡§®‡•á‡§Ç</th><th>‡§´‡•ã‡§ü‡•ã</th><th>‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ï‡•ã‡§∞‡•ç‡§∏</th><th>‡§π‡§æ‡§ú‡§ø‡§∞‡•Ä</th><th>‡§´‡•Ä‡§∏ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</th><th>‡§á‡§®‡§æ‡§Æ</th><th>‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-green" onclick="showForm('payment-form')">üí∞ ‡§´‡•Ä‡§∏ ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
    <button class="btn btn-blue" onclick="showForm('extra-charge-form')">üìë ‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú</button>
    <button class="btn btn-orange" onclick="location.href='attendence.html'">üìù ‡§Ö‡§ü‡•á‡§Ç‡§°‡•á‡§Ç‡§∏ ‡§≠‡§∞‡•á‡§Ç</button>
    <button class="btn btn-yellow" onclick="openScracityModal()">üéÅ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•à‡§ö ‡§ï‡•Ç‡§™‡§®</button>
    <button class="btn btn-red" onclick="openDeleteLock()">üóëÔ∏è ‡§ö‡§Ø‡§®‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <div id="payment-form" class="form-box">
    <h3 style="margin-top:0; color:var(--primary)">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§´‡•Ä‡§∏ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</h3>
    <select id="p-month"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select>
    <input type="number" id="p-amount" placeholder="‡§∞‡§æ‡§∂‡§ø (Amount) ‚Çπ">
    <button class="btn btn-green" style="width:100%" onclick="genQRCode('fee')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="extra-charge-form" class="form-box">
    <h3 style="margin-top:0; color:var(--secondary)">‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú (Fine/Book/Adm)</h3>
    <input type="text" id="e-reason" placeholder="‡§ï‡§æ‡§∞‡§£ (Reason)">
    <input type="number" id="e-amount" placeholder="‡§∞‡§æ‡§∂‡§ø (Amount) ‚Çπ">
    <button class="btn btn-blue" style="width:100%" onclick="genQRCode('extra')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="password-modal">
    <div class="modal-content">
        <h3 style="color:var(--danger)">üîí ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</h3>
        <input type="password" id="pin-input" readonly placeholder="******" style="text-align:center; font-size:20px; border:2px solid #eee;">
        <div class="calc-grid">
            <button class="calc-btn" onclick="addPin('1')">1</button>
            <button class="calc-btn" onclick="addPin('2')">2</button>
            <button class="calc-btn" onclick="addPin('3')">3</button>
            <button class="calc-btn" onclick="addPin('4')">4</button>
            <button class="calc-btn" onclick="addPin('5')">5</button>
            <button class="calc-btn" onclick="addPin('6')">6</button>
            <button class="calc-btn" onclick="addPin('7')">7</button>
            <button class="calc-btn" onclick="addPin('8')">8</button>
            <button class="calc-btn" onclick="addPin('9')">9</button>
            <button class="calc-btn" style="color:red" onclick="clearPin()">C</button>
            <button class="calc-btn" onclick="addPin('0')">0</button>
            <button class="calc-btn" style="color:green" onclick="verifyPin()">OK</button>
        </div>
        <button onclick="closePinModal()" style="margin-top:15px; border:none; background:none; color:gray; cursor:pointer;">‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
    </div>
  </div>

  <div id="common-modal">
      <div class="modal-content" id="qr-ui" style="display:none;">
          <h3 id="qr-title" style="margin-top:0; color:var(--primary);">Sandeep Kumar</h3>
          <div id="qrcode-container" style="display: flex; justify-content: center; padding:10px; background:#f9f9f9; border-radius:15px;"></div>
          <p id="qr-text" style="font-weight:bold; margin-top:15px; color:#333;"></p>
          <button class="btn btn-green" id="confirm-btn">‚úÖ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§´‡§≤ ‡§π‡•Å‡§Ü</button>
          <button onclick="closeModal()" style="color:var(--danger); margin-top:15px; background:none; border:none; cursor:pointer;">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>

      <div class="modal-content" id="scratch-ui" style="display:none;">
          <div class="scratch-container">
              <div class="reward-under">
                  <h2 style="margin:0; color:var(--primary);">‡§Æ‡•Å‡§¨‡§æ‡§∞‡§ï ‡§π‡•ã!</h2>
                  <h1 id="win-txt" style="font-size:45px; margin:10px 0; color:var(--success);">‚Çπ0</h1>
              </div>
              <canvas id="scratch-canvas" width="260" height="260"></canvas>
          </div>
          <button onclick="closeModal()" class="btn btn-orange" style="width:100%; margin-top:10px;">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
  </div>

  <script>
    // --- SNT COMPUTER INSTITUTE API CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA",
        authDomain: "snt-computer-institute.firebaseapp.com",
        databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/",
        projectId: "snt-computer-institute",
        storageBucket: "snt-computer-institute.firebasestorage.app",
        messagingSenderId: "117580784781",
        appId: "1:117580784781:web:73ba19d2d008beb3a5eec4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let usersData = [];
    let currentId = null; 
    let enteredPin = "";
    const MASTER_PIN = "912919";

    // --- REALT-TIME DATA LOAD FROM CLOUD ---
    function fetchStudents() {
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            usersData = [];

            if (data) {
                Object.keys(data).forEach((key) => {
                    let u = data[key];
                    u.id = key; 
                    usersData.push(u);

                    let pHist = (u.paymentHistory || []).map(p => `<span class="fee-badge">${p.month}: ‚Çπ${p.amount}</span>`).join('');
                    let eHist = (u.extraHistory || []).map(e => `<span class="fee-badge extra-badge">${e.reason}: ‚Çπ${e.amount}</span>`).join('');

                    tbody.innerHTML += `<tr>
                      <td><input type="checkbox" class="st-check" data-id="${key}"></td>
                      <td><img src="${u.profilePicture || 'https://via.placeholder.com/50'}" class="profile-img"></td>
                      <td style="text-align:left;"><b>${u.name}</b><br><small>${u.mobile || '---'}</small></td>
                      <td><span class="fee-badge extra-badge">${u.courses ? u.courses[0] : (u.course || 'N/A')}</span></td>
                      <td onclick="location.href='calendar.html?id=${key}&name=${u.name}'" style="cursor:pointer;"><div class="att-count">Check Status</div></td>
                      <td><div style="max-width:200px; margin:auto;">${pHist} ${eHist}</div></td>
                      <td style="color:var(--success); font-weight:bold;">‚Çπ${u.wonCash || 0}</td>
                      <td><button class="btn" style="padding:5px; background:#eee;" onclick="window.location.href='basic.html?search=${u.name}'">üñ®Ô∏è</button></td>
                    </tr>`;
                });
            }
        });
    }

    // --- DELETE LOCK FUNCTIONS ---
    function openDeleteLock() {
        let chks = document.querySelectorAll('.st-check:checked');
        if(chks.length == 0) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        enteredPin = "";
        document.getElementById('pin-input').value = "";
        document.getElementById('password-modal').style.display = 'flex';
    }

    function addPin(num) {
        if(enteredPin.length < 6) {
            enteredPin += num;
            document.getElementById('pin-input').value = enteredPin.replace(/./g, '‚óè');
        }
    }

    function clearPin() {
        enteredPin = "";
        document.getElementById('pin-input').value = "";
    }

    function closePinModal() {
        document.getElementById('password-modal').style.display = 'none';
    }

    function verifyPin() {
        if(enteredPin === MASTER_PIN) {
            deleteRows();
            closePinModal();
        } else {
            alert("‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°! ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ‡•§");
            clearPin();
        }
    }

    function deleteRows() {
        let chks = Array.from(document.querySelectorAll('.st-check:checked'));
        if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§® " + chks.length + " ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§∏‡•á ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
        
        chks.forEach(c => {
            let id = c.dataset.id;
            db.ref('students/' + id).remove();
        });
        alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
    }

    // --- PAYMENT QR LOGIC ---
    function genQRCode(type) {
        const sel = document.querySelector('.st-check:checked');
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id;
        
        let amt = (type === 'fee') ? document.getElementById('p-amount').value : document.getElementById('e-amount').value;
        let label = (type === 'fee') ? document.getElementById('p-month').value : (document.getElementById('e-reason').value || "Charge");
        if(!amt) return alert("‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!");

        let student = usersData.find(u => u.id === currentId);

        document.getElementById('common-modal').style.display='flex';
        document.getElementById('qr-ui').style.display='block';
        document.getElementById('scratch-ui').style.display='none';
        document.getElementById('qrcode-container').innerHTML = "";
        
        new QRCode(document.getElementById('qrcode-container'), { text: `upi://pay?pa=9580807075@ybl&pn=Sandeep%20Kumar&am=${amt}&cu=INR`, width:180, height:180 });
        document.getElementById('qr-title').innerText = student.name;
        document.getElementById('qr-text').innerText = `${label}: ‚Çπ${amt}`;
        document.getElementById('confirm-btn').onclick = function() { confirmPayment(type, amt, label); };
    }

    function confirmPayment(type, amt, label) {
        let student = usersData.find(u => u.id === currentId);
        
        if(type === 'fee') {
            if(!student.paymentHistory) student.paymentHistory = [];
            student.paymentHistory.push({month: label, amount: amt, date: new Date().toLocaleDateString()});
        } else {
            if(!student.extraHistory) student.extraHistory = [];
            student.extraHistory.push({reason: label, amount: amt, date: new Date().toLocaleDateString()});
        }
        
        db.ref('students/' + currentId).update(student).then(() => {
            closeModal();
            const receiptData = {
                name: student.name,
                photo: student.profilePicture,
                course: student.courses ? student.courses[0] : (student.course || "N/A"),
                type: type === 'fee' ? "Monthly Fee" : "Other Charges",
                description: label,
                amount: amt,
                date: new Date().toLocaleString()
            };
            localStorage.setItem('lastReceipt', JSON.stringify(receiptData));
            window.open('receipt.html', '_blank');
        });
    }

    // --- SCRATCH CARD LOGIC ---
    const canvas = document.getElementById('scratch-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function openScracityModal() {
        const sel = document.querySelector('.st-check:checked');
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id;
        const win = Math.floor(Math.random() * 20) + 1;
        document.getElementById('win-txt').innerText = `‚Çπ${win}`;
        window.lastWin = win;
        
        canvas.style.opacity = '1';
        document.getElementById('common-modal').style.display='flex';
        document.getElementById('scratch-ui').style.display='block';
        document.getElementById('qr-ui').style.display='none';
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#C0C0C0';
        ctx.fillRect(0, 0, 260, 260);
    }

    window.addEventListener('mouseup', () => {
        if(isDrawing && window.lastWin) {
            let student = usersData.find(u => u.id === currentId);
            let newWon = (parseInt(student.wonCash) || 0) + window.lastWin;
            db.ref('students/' + currentId).update({wonCash: newWon});
            window.lastWin = null;
        }
        isDrawing = false;
    });

    function showForm(id) {
        document.querySelectorAll('.form-box').forEach(f => f.style.display = 'none');
        if(id !== 'none') document.getElementById(id).style.display = 'block';
    }
    function closeModal() { document.getElementById('common-modal').style.display='none'; }
    function filterTable() {
        let input = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('#table-body tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    }

    canvas.addEventListener('mousedown', () => isDrawing = true);
    canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
    window.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 40; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y); ctx.stroke();
    });
    canvas.addEventListener('touchmove', (e) => {
        if (!isDrawing) return;
        const r = canvas.getBoundingClientRect();
        const x = e.touches[0].clientX - r.left;
        const y = e.touches[0].clientY - r.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 40; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y); ctx.stroke();
    });

    window.onload = fetchStudents;
  </script>
</body>
</html>
            <tr>
              <th>‡§ö‡•Å‡§®‡•á‡§Ç</th><th>‡§´‡•ã‡§ü‡•ã</th><th>‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ï‡•ã‡§∞‡•ç‡§∏</th><th>‡§π‡§æ‡§ú‡§ø‡§∞‡•Ä</th><th>‡§´‡•Ä‡§∏ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</th><th>‡§á‡§®‡§æ‡§Æ</th><th>‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-green" onclick="showForm('payment-form')">üí∞ ‡§´‡•Ä‡§∏ ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
    <button class="btn btn-blue" onclick="showForm('extra-charge-form')">üìë ‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú</button>
    <button class="btn btn-orange" onclick="location.href='attendence.html'">üìù ‡§Ö‡§ü‡•á‡§Ç‡§°‡•á‡§Ç‡§∏ ‡§≠‡§∞‡•á‡§Ç</button>
    <button class="btn btn-yellow" onclick="openScracityModal()">üéÅ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•à‡§ö ‡§ï‡•Ç‡§™‡§®</button>
    <button class="btn btn-red" onclick="deleteRows()">üóëÔ∏è ‡§ö‡§Ø‡§®‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <div id="payment-form" class="form-box">
    <h3 style="margin-top:0; color:var(--primary)">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§´‡•Ä‡§∏ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</h3>
    <select id="p-month"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select>
    <input type="number" id="p-amount" placeholder="‡§∞‡§æ‡§∂‡§ø (Amount) ‚Çπ">
    <button class="btn btn-green" style="width:100%" onclick="genQRCode('fee')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="extra-charge-form" class="form-box">
    <h3 style="margin-top:0; color:var(--secondary)">‡§Ö‡§®‡•ç‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ú (Fine/Book/Adm)</h3>
    <input type="text" id="e-reason" placeholder="‡§ï‡§æ‡§∞‡§£ (Reason)">
    <input type="number" id="e-amount" placeholder="‡§∞‡§æ‡§∂‡§ø (Amount) ‚Çπ">
    <button class="btn btn-blue" style="width:100%" onclick="genQRCode('extra')">QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
  </div>

  <div id="common-modal">
      <div class="modal-content" id="qr-ui" style="display:none;">
          <h3 id="qr-title" style="margin-top:0; color:var(--primary);">Sandeep Kumar</h3>
          <div id="qrcode-container" style="display: flex; justify-content: center; padding:10px; background:#f9f9f9; border-radius:15px;"></div>
          <p id="qr-text" style="font-weight:bold; margin-top:15px; color:#333;"></p>
          <button class="btn btn-green" id="confirm-btn">‚úÖ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§´‡§≤ ‡§π‡•Å‡§Ü</button>
          <button onclick="closeModal()" style="color:var(--danger); margin-top:15px; background:none; border:none; cursor:pointer;">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>

      <div class="modal-content" id="scratch-ui" style="display:none;">
          <div class="scratch-container">
              <div class="reward-under">
                  <h2 style="margin:0; color:var(--primary);">‡§Æ‡•Å‡§¨‡§æ‡§∞‡§ï ‡§π‡•ã!</h2>
                  <h1 id="win-txt" style="font-size:45px; margin:10px 0; color:var(--success);">‚Çπ0</h1>
              </div>
              <canvas id="scratch-canvas" width="260" height="260"></canvas>
          </div>
          <button onclick="closeModal()" class="btn btn-orange" style="width:100%; margin-top:10px;">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
  </div>

  <script>
    // --- SNT COMPUTER INSTITUTE API CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA",
        authDomain: "snt-computer-institute.firebaseapp.com",
        databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/",
        projectId: "snt-computer-institute",
        storageBucket: "snt-computer-institute.firebasestorage.app",
        messagingSenderId: "117580784781",
        appId: "1:117580784781:web:73ba19d2d008beb3a5eec4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let usersData = [];
    let currentId = null; // Firebase Unique Key

    // --- REALT-TIME DATA LOAD FROM CLOUD ---
    function fetchStudents() {
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            usersData = [];

            if (data) {
                Object.keys(data).forEach((key) => {
                    let u = data[key];
                    u.id = key; // Firebase key store karein
                    usersData.push(u);

                    // Attendance counts
                    let pCount = 0, aCount = 0;
                    // Note: Attendance logic remains global or can be fetched per student
                    
                    let pHist = (u.paymentHistory || []).map(p => `<span class="fee-badge">${p.month}: ‚Çπ${p.amount}</span>`).join('');
                    let eHist = (u.extraHistory || []).map(e => `<span class="fee-badge extra-badge">${e.reason}: ‚Çπ${e.amount}</span>`).join('');

                    tbody.innerHTML += `<tr>
                      <td><input type="checkbox" class="st-check" data-id="${key}"></td>
                      <td><img src="${u.profilePicture || 'https://via.placeholder.com/50'}" class="profile-img"></td>
                      <td style="text-align:left;"><b>${u.name}</b><br><small>${u.mobile || '---'}</small></td>
                      <td><span class="fee-badge extra-badge">${u.courses ? u.courses[0] : (u.course || 'N/A')}</span></td>
                      <td onclick="location.href='calendar.html?id=${key}&name=${u.name}'" style="cursor:pointer;"><div class="att-count">Check Status</div></td>
                      <td><div style="max-width:200px; margin:auto;">${pHist} ${eHist}</div></td>
                      <td style="color:var(--success); font-weight:bold;">‚Çπ${u.wonCash || 0}</td>
                      <td><button class="btn" style="padding:5px; background:#eee;" onclick="window.location.href='basic.html?search=${u.name}'">üñ®Ô∏è</button></td>
                    </tr>`;
                });
            }
        });
    }

    // --- PAYMENT QR LOGIC ---
    function genQRCode(type) {
        const sel = document.querySelector('.st-check:checked');
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id;
        
        let amt = (type === 'fee') ? document.getElementById('p-amount').value : document.getElementById('e-amount').value;
        let label = (type === 'fee') ? document.getElementById('p-month').value : (document.getElementById('e-reason').value || "Charge");
        if(!amt) return alert("‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç!");

        let student = usersData.find(u => u.id === currentId);

        document.getElementById('common-modal').style.display='flex';
        document.getElementById('qr-ui').style.display='block';
        document.getElementById('scratch-ui').style.display='none';
        document.getElementById('qrcode-container').innerHTML = "";
        
        new QRCode(document.getElementById('qrcode-container'), { text: `upi://pay?pa=9580807075@ybl&pn=Sandeep%20Kumar&am=${amt}&cu=INR`, width:180, height:180 });
        document.getElementById('qr-title').innerText = student.name;
        document.getElementById('qr-text').innerText = `${label}: ‚Çπ${amt}`;
        document.getElementById('confirm-btn').onclick = function() { confirmPayment(type, amt, label); };
    }

    function confirmPayment(type, amt, label) {
        let student = usersData.find(u => u.id === currentId);
        
        if(type === 'fee') {
            if(!student.paymentHistory) student.paymentHistory = [];
            student.paymentHistory.push({month: label, amount: amt, date: new Date().toLocaleDateString()});
        } else {
            if(!student.extraHistory) student.extraHistory = [];
            student.extraHistory.push({reason: label, amount: amt, date: new Date().toLocaleDateString()});
        }
        
        // Save to Firebase
        db.ref('students/' + currentId).update(student).then(() => {
            closeModal();
            // Receipt Data for receipt.html
            const receiptData = {
                name: student.name,
                photo: student.profilePicture,
                course: student.courses ? student.courses[0] : (student.course || "N/A"),
                type: type === 'fee' ? "Monthly Fee" : "Other Charges",
                description: label,
                amount: amt,
                date: new Date().toLocaleString()
            };
            localStorage.setItem('lastReceipt', JSON.stringify(receiptData));
            window.open('receipt.html', '_blank');
        });
    }

    // --- SCRATCH CARD CLOUD SYNC ---
    const canvas = document.getElementById('scratch-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function openScracityModal() {
        const sel = document.querySelector('.st-check:checked');
        if(!sel) return alert("‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç!");
        currentId = sel.dataset.id;
        const win = Math.floor(Math.random() * 20) + 1;
        document.getElementById('win-txt').innerText = `‚Çπ${win}`;
        window.lastWin = win;
        
        canvas.style.opacity = '1';
        document.getElementById('common-modal').style.display='flex';
        document.getElementById('scratch-ui').style.display='block';
        document.getElementById('qr-ui').style.display='none';
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#C0C0C0';
        ctx.fillRect(0, 0, 260, 260);
    }

    window.addEventListener('mouseup', () => {
        if(isDrawing && window.lastWin) {
            let student = usersData.find(u => u.id === currentId);
            let newWon = (parseInt(student.wonCash) || 0) + window.lastWin;
            db.ref('students/' + currentId).update({wonCash: newWon});
            window.lastWin = null;
        }
        isDrawing = false;
    });

    // --- DELETE FROM CLOUD ---
    function deleteRows() {
        let chks = Array.from(document.querySelectorAll('.st-check:checked'));
        if(chks.length == 0) return;
        if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§® ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§∏‡•á ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
        
        chks.forEach(c => {
            let id = c.dataset.id;
            db.ref('students/' + id).remove();
        });
        alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
    }

    // Utility Functions
    function showForm(id) {
        document.querySelectorAll('.form-box').forEach(f => f.style.display = 'none');
        if(id !== 'none') document.getElementById(id).style.display = 'block';
    }
    function closeModal() { document.getElementById('common-modal').style.display='none'; }
    function filterTable() {
        let input = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('#table-body tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    }

    // Scratch Drawing logic remains same
    canvas.addEventListener('mousedown', () => isDrawing = true);
    canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
    window.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 40; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y); ctx.stroke();
    });

    window.onload = fetchStudents;
  </script>
</body>
</html>
