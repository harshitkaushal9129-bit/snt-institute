<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNT Computer Institute - Admission & Data Retrieval</title>
    <link rel="icon" type="image/jpeg" href="https://harshitkaushal9129-bit.github.io/snt-institute/SNT.jpg">
    <link rel="apple-touch-icon" href="https://harshitkaushal9129-bit.github.io/snt-institute/SNT.jpg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <style>
        :root { --primary: #2563eb; --primary-dark: #1e40af; --bg: #f0f4f8; --text: #1e293b; --card: #ffffff; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.8s ease; }
        .splash-content { text-align: center; animation: pulse 2s infinite; }
        .splash-content img { width: 150px; border-radius: 50%; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .container { max-width: 1000px; margin: 50px auto; background: var(--card); padding: 50px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); visibility: hidden; }
        header { text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid #f1f5f9; }
        header img { width: 320px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
        header h2 { text-transform: uppercase; letter-spacing: 4px; color: var(--primary); margin: 10px 0; font-size: 32px; font-weight: 800; }
        header p { color: #64748b; font-size: 18px; margin: 0; }

        .section-title { background: #eff6ff; color: var(--primary); padding: 12px 20px; border-radius: 10px; font-weight: 700; margin: 40px 0 25px 0; border-left: 6px solid var(--primary); font-size: 18px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-group { margin-bottom: 22px; }
        label { display: block; font-weight: 600; margin-bottom: 10px; font-size: 14.5px; color: #475569; }
        
        input[type="text"], input[type="email"], input[type="number"], input[type="date"], select { 
            width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: 0.3s; box-sizing: border-box; 
        }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }

        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #f8fafc; padding: 25px; border-radius: 16px; }
        .checkbox-item { display: flex; align-items: center; font-size: 14px; cursor: pointer; }
        .checkbox-item input { margin-right: 12px; width: 19px; height: 19px; accent-color: var(--primary); }

        .btn-next { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; 
            padding: 20px; font-size: 20px; font-weight: bold; border-radius: 14px; cursor: pointer; width: 100%; margin-top: 30px; 
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); transition: 0.3s;
        }
        .btn-next:disabled { background: #cbd5e1; cursor: not-allowed; }

        #payment-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 9999; backdrop-filter: blur(10px); }
        #payment-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; text-align: center; border-radius: 30px; width: 380px; }
        
        @media (max-width: 850px) { .row { grid-template-columns: 1fr; } .grid-container { grid-template-columns: repeat(2, 1fr); } header img { width: 280px; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="splash-screen">
        <div class="splash-content"><img src="SNT.jpg" alt="Logo"><h1 style="color: var(--primary); font-size: 28px; margin-top: 20px;">SNT Computer Institute</h1></div>
    </div>

    <div class="container" id="main-app-content">
        <header><img src="Logo.jpg" alt="Logo"><h2>Admission Form</h2><p>Rudauli Ayodhya | Success Starts Here</p></header>
        
        <form id="admission-form">
            <div class="section-title">Step 1: Contact Details (Verification)</div>
            <div class="row">
                <div class="form-group">
                    <label>Gmail Address</label>
                    <input type="email" id="email" name="email" required placeholder="Enter your Gmail">
                </div>
                <div class="form-group">
                    <label>Mobile Number</label>
                    <input type="number" id="phone" name="phone" required placeholder="10-digit mobile">
                </div>
            </div>

            <div class="section-title">Step 2: Personal Information</div>
            <div class="row">
                <div class="form-group"><label>Full Name</label><input type="text" id="name" name="name" required placeholder="Student Name"></div>
                <div class="form-group"><label>Father's Name</label><input type="text" id="fatherName" name="fatherName" placeholder="Father's Name"></div>
            </div>

            <div class="section-title">Step 3: Select Course</div>
            <div class="grid-container" id="course-list">
                <label class="checkbox-item"><input type="checkbox" name="course" value="DCA"> DCA</label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="ADCA"> ADCA</label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="CCC"> CCC</label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="Tally"> Tally</label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="Web Design"> Web Design</label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="Python"> Python</label>
            </div>

            <div class="section-title">Step 4: Upload & Date</div>
            <div class="row">
                <div class="form-group"><label>Profile Photo</label><input type="file" id="profile-picture" accept="image/*"></div>
                <div class="form-group"><label>Today's Date</label><input type="date" id="current-date" name="date"></div>
            </div>

            <button type="button" id="btn-next" class="btn-next">VALIDATE & PROCEED</button>

            <div id="payment-overlay">
                <div id="payment-box">
                    <h2 style="font-size: 40px; margin: 0; color: #10b981;">â‚¹100</h2>
                    <p style="color: #64748b; margin-bottom: 20px;">Admission Fee Payment</p>
                    <div id="qr-container" style="display: flex; justify-content: center; margin-bottom: 20px;"></div>
                    <button type="submit" id="final-submit-btn" style="width:100%; padding:16px; background:#2563eb; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">I HAVE PAID - FINAL SUBMIT</button>
                    <p onclick="document.getElementById('payment-overlay').style.display='none'" style="margin-top:20px; color:#ef4444; cursor:pointer; font-weight:600;">Cancel & Edit</p>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA", 
            authDomain: "snt-computer-institute.firebaseapp.com", 
            databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/", 
            projectId: "snt-computer-institute", 
            appId: "1:117580784781:web:73ba19d2d008beb3a5eec4" 
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        const btnNext = document.getElementById('btn-next');
        const paymentOverlay = document.getElementById('payment-overlay');

        window.onload = () => {
            setTimeout(() => { 
                document.getElementById('splash-screen').style.display = 'none'; 
                document.getElementById('main-app-content').style.visibility = 'visible'; 
            }, 2000);
            document.getElementById('current-date').valueAsDate = new Date();
        };

        // --- Core Logic: Retrieve or Register ---
        btnNext.addEventListener('click', async () => {
            const emailVal = document.getElementById('email').value.trim();
            const nameField = document.getElementById('name');
            const phoneField = document.getElementById('phone');

            if(!emailVal) { alert("Please enter Gmail ID first!"); return; }

            btnNext.innerText = "Checking Database...";
            btnNext.disabled = true;

            try {
                const studentsRef = ref(database, 'students');
                const emailQuery = query(studentsRef, orderByChild("email"), equalTo(emailVal));
                const snapshot = await get(emailQuery);

                if (snapshot.exists()) {
                    // --- USER ALREADY EXISTS: RETRIEVE DATA ---
                    let userData;
                    snapshot.forEach(child => { userData = child.val(); });

                    alert(`Record Found!\n\nID: ${userData.studentId}\nName: ${userData.name}\nStatus: ${userData.registrationStatus}`);
                    
                    // Auto-fill fields for the user
                    nameField.value = userData.name;
                    phoneField.value = userData.mobile || userData.phone;
                    document.getElementById('fatherName').value = userData.fatherName || '';
                    
                    btnNext.innerText = "DATA RETRIEVED (NO NEED TO STORE)";
                    btnNext.style.background = "#10b981";
                    // Data retrieve hone par payment box nahi dikhayenge
                } else {
                    // --- NEW USER: SHOW PAYMENT & STORE ---
                    if(!nameField.value || !phoneField.value) {
                        alert("Please fill Name and Mobile to proceed!");
                        btnNext.innerText = "VALIDATE & PROCEED";
                        btnNext.disabled = false;
                        return;
                    }
                    showQR();
                }
            } catch (err) {
                console.error(err);
                alert("Technical Error. Check Firebase Rules.");
                btnNext.disabled = false;
            }
        });

        function showQR() {
            const qrContainer = document.getElementById('qr-container');
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: `upi://pay?pa=9580807075@ybl&pn=Sandeep%20Kumar&am=100&cu=INR`, width:180, height:180 });
            paymentOverlay.style.display = 'block';
            btnNext.innerText = "VALIDATE & PROCEED";
            btnNext.disabled = false;
        }

        // Final Submit (Only for New Users)
        document.getElementById('admission-form').onsubmit = (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('final-submit-btn');
            submitBtn.innerText = "Creating Profile...";
            submitBtn.disabled = true;

            const profileFile = document.getElementById('profile-picture').files[0];
            const reader = new FileReader();

            const saveData = (imgBase64) => {
                const studentsRef = ref(database, 'students');
                const newRef = push(studentsRef);
                const customId = "SNT-" + Math.floor(1000 + Math.random() * 9000);

                const data = {
                    studentId: customId,
                    name: document.getElementById('name').value.toUpperCase(),
                    email: document.getElementById('email').value.trim(),
                    mobile: document.getElementById('phone').value,
                    fatherName: document.getElementById('fatherName').value,
                    courses: Array.from(document.querySelectorAll('input[name="course"]:checked')).map(c => c.value),
                    profilePicture: imgBase64 || "",
                    admissionDate: document.getElementById('current-date').value,
                    registrationStatus: "Paid",
                    timestamp: new Date().toISOString()
                };

                set(newRef, data).then(() => {
                    alert("Success! Your ID: " + customId);
                    window.location.reload();
                });
            };

            if (profileFile) {
                reader.onload = () => saveData(reader.result);
                reader.readAsDataURL(profileFile);
            } else {
                saveData("");
            }
        };
    </script>
</body>
</html>
