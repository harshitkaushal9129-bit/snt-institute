<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>SNT Certificate - Verification System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        html, body { 
            margin: 0; padding: 0; width: 100%; min-height: 100vh;
            background: #2c3e50; font-family: 'Arial', sans-serif;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Nav Bar */
        .top-nav {
            width: 100%; background: #1a252f; padding: 15px 20px;
            display: flex; justify-content: center; gap: 20px;
            align-items: center; position: sticky; top: 0; z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        .search-box {
            padding: 10px 15px; width: 300px; border-radius: 5px;
            border: 2px solid #00b0f0; font-size: 16px; outline: none;
        }

        .print-btn {
            background: #27ae60; color: white; border: none; padding: 10px 25px;
            font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer;
        }

        /* Certificate Design */
        #certificate-wrapper {
            margin-top: 30px; display: none; justify-content: center; padding-bottom: 50px;
        }

        #certificate {
            width: 1120px; height: 790px;
            background-image: url('https://i.ibb.co/XfXf8xR/snt-cert-bg.png'); 
            background-size: cover; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform-origin: top center;
        }

        #userImg {
            position: absolute; top: 58px; right: 65px;
            width: 115px; height: 140px;
            border: 3px solid #000; object-fit: cover;
        }

        .text-overlay {
            position: absolute; width: 100%; text-align: center;
            font-weight: bold; color: #1a252f;
        }

        #dName { top: 385px; font-size: 48px; text-transform: uppercase; color: #b45f06; }
        #dCourse { top: 535px; font-size: 32px; color: #073763; }

        /* QR Code Styling */
        #qrcode {
            position: absolute; bottom: 60px; right: 75px;
            background: white; padding: 8px; border: 1px solid #ccc;
        }

        @media print {
            .top-nav { display: none; }
            body { background: white; }
            #certificate-wrapper { margin: 0; }
        }
    </style>
</head>
<body>

    <div class="top-nav">
        <input type="text" id="searchInput" class="search-box" placeholder="SNT-ID ya Phone डालें">
        <button class="print-btn" onclick="handleSearch()">Search & Verify</button>
        <button class="print-btn" style="background:#2980b9" onclick="window.print()">Print PDF</button>
    </div>

    <div id="certificate-wrapper">
        <div id="certificate">
            <img id="userImg" src="https://via.placeholder.com/115x140" alt="Photo">
            <div id="dName" class="text-overlay">STUDENT NAME</div>
            <div id="dCourse" class="text-overlay">COURSE NAME</div>
            
            <div id="qrcode"></div>
        </div>
    </div>

    <div id="notFound" style="display:none; color:white; margin-top:100px; text-align:center;">
        <h1>ID नहीं मिली!</h1>
        <p>कृपया सही Student ID दर्ज करें। (Eg: SNT-XXXXX)</p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAOQtM_XYLqPgxMK1XBdfl0m7KoAseZRCA",
            authDomain: "snt-computer-institute.firebaseapp.com",
            databaseURL: "https://snt-computer-institute-default-rtdb.firebaseio.com/",
            projectId: "snt-computer-institute",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function generateQR(studentId) {
            const verifyURL = `https://harshitkaushal9129-bit.github.io/snt-institute/verify.html?id=${studentId}`;
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; 

            new QRCode(qrContainer, {
                text: verifyURL,
                width: 90,
                height: 90,
                colorDark : "#000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // Updated checkData: Ab ye Student ID se search karega
        function checkData(searchId) {
            const wrapper = document.getElementById('certificate-wrapper');
            const notFound = document.getElementById('notFound');

            if(!searchId) return;

            // Search logic optimized: Ye "studentId" field ke andar check karega
            db.ref('students').orderByChild('studentId').equalTo(searchId.toUpperCase()).once('value', snap => {
                const data = snap.val();
                if (data) {
                    // Firebase query ek object return karti hai, uska pehla record lenge
                    const key = Object.keys(data)[0];
                    const student = data[key];

                    wrapper.style.display = 'flex';
                    notFound.style.display = 'none';
                    
                    document.getElementById('dName').innerText = student.name;
                    document.getElementById('dCourse').innerText = student.course || (student.courses ? student.courses[0] : "Computer Application");
                    document.getElementById('userImg').src = student.profilePicture || 'https://via.placeholder.com/115x140';
                    
                    // QR mein wahi ID jayegi jo database mein hai
                    generateQR(student.studentId || key);
                    
                    fitToScreen();
                } else {
                    // Agar StudentId se nahi mila, toh purana logic (Firebase Key) bhi check kar lete hain backup ke liye
                    db.ref('students/' + searchId).once('value', snap2 => {
                        const student2 = snap2.val();
                        if(student2) {
                            wrapper.style.display = 'flex';
                            notFound.style.display = 'none';
                            document.getElementById('dName').innerText = student2.name;
                            document.getElementById('dCourse').innerText = student2.course || (student2.courses ? student2.courses[0] : "Computer Application");
                            document.getElementById('userImg').src = student2.profilePicture || 'https://via.placeholder.com/115x140';
                            generateQR(searchId);
                            fitToScreen();
                        } else {
                            wrapper.style.display = 'none';
                            notFound.style.display = 'block';
                        }
                    });
                }
            });
        }

        function handleSearch() {
            let input = document.getElementById('searchInput').value.trim();
            if(input) checkData(input);
        }

        function fitToScreen() {
            const cert = document.getElementById('certificate');
            const winW = window.innerWidth - 40;
            if (winW < 1120) {
                cert.style.transform = `scale(${winW / 1120})`;
            } else {
                cert.style.transform = `scale(1)`;
            }
        }

        window.addEventListener('resize', fitToScreen);
        
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if(id) {
                document.getElementById('searchInput').value = id;
                checkData(id);
            }
        };
    </script>
</body>
</html>
